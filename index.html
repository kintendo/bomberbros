<!DOCTYPE html>
<html>
<head>
<script src="/socket.io/socket.io.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/coffee-script/1.6.3/coffee-script.min.js"></script>
<link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

	<select id="games"></select>
	<button class="btn" onClick="join_game()">Join Game</button>
	<button class="btn" onClick="fetch_games()">Refresh List</button>
	<input id="input_create"></input>
	<button class="btn" onCLick="create_game()">Create Game</button>

	<br></br>

	<canvas id="canvas"></canvas>

</body>

<script type="text/coffeescript">

	client = exports ? this

	url = "http://dl.dropboxusercontent.com/u/261248/bmbro/"

	canvas = $("#canvas")[0]
	canvas.width = 13*50 #x-coord
	canvas.height = 11*50 #y-coord
	ctx = canvas.getContext("2d")

	#load all images
	images = []
	images["bomb"] = new Image()
	images["bomb"].src = "#{url}bomb.png"
	images["flame"] = new Image()
	images["flame"].src = "#{url}flame.gif"
	#white player
	images["bro_1_down"] = new Image()
	images["bro_1_down"].src = "#{url}bro_down.png"
	images["bro_1_up"] = new Image()
	images["bro_1_up"].src = "#{url}bro_up.png"
	images["bro_1_left"] = new Image()
	images["bro_1_left"].src = "#{url}bro_left.png"
	images["bro_1_right"] = new Image()
	images["bro_1_right"].src = "#{url}bro_right.png"
	#blk player
	images["bro_2_down"] = new Image()
	images["bro_2_down"].src = "#{url}bro_blk_down.png"
	images["bro_2_up"] = new Image()
	images["bro_2_up"].src = "#{url}bro_blk_up.png"
	images["bro_2_left"] = new Image()
	images["bro_2_left"].src = "#{url}bro_blk_left.png"
	images["bro_2_right"] = new Image()
	images["bro_2_right"].src = "#{url}bro_blk_right.png"
	#blue player
	images["bro_3_down"] = new Image()
	images["bro_3_down"].src = "#{url}bro_blu_down.png"
	images["bro_3_up"] = new Image()
	images["bro_3_up"].src = "#{url}bro_blu_up.png"
	images["bro_3_left"] = new Image()
	images["bro_3_left"].src = "#{url}bro_blu_left.png"
	images["bro_3_right"] = new Image()
	images["bro_3_right"].src = "#{url}bro_blu_right.png"
	#red player
	images["bro_4_down"] = new Image()
	images["bro_4_down"].src = "#{url}bro_red_down.png"
	images["bro_4_up"] = new Image()
	images["bro_4_up"].src = "#{url}bro_red_up.png"
	images["bro_4_left"] = new Image()
	images["bro_4_left"].src = "#{url}bro_red_left.png"
	images["bro_4_right"] = new Image()
	images["bro_4_right"].src = "#{url}bro_red_right.png"

	socket = io.connect()

	socket.on 'game_list', (data) ->
		console.debug data
		list = JSON.parse(data.list)
		$("#games").html("")
		for item in list
			$("#games").append("<option>#{item}</option>")
		$("#games").prop("size", list.length)

	socket.on 'game_map', (data) ->
		map = JSON.parse data.map
		xpos = 0
		ypos = 0
		#draw map
		for tile in map
			if tile is "X"
				ctx.fillStyle = "rgb(200,0,0)"
				ctx.fillRect(xpos, ypos, 50, 50)
			else if tile is "C"
				ctx.fillStyle = "rgb(0,0,200)"
				ctx.fillRect(xpos, ypos, 50, 50)
			else
				ctx.fillStyle = "rgb(0,200,0)"
				ctx.fillRect(xpos, ypos, 50, 50)
			if xpos is 600
				xpos = 0
				ypos = ypos + 50
			else
				xpos = xpos + 50
		#draw bros
		bros = JSON.parse data.bros
		for bro in bros
			ctx.drawImage(images["bro_#{bro.playerNum}_#{bro.direction}"], bro.x*50, bro.y*50, 50, 50)
		#draw drops
		#draw bombs
		bombs = JSON.parse data.bombs
		for bomb of bombs
			ctx.drawImage(images["bomb"], bombs[bomb].x*50, bombs[bomb].y*50, 50, 50)
		flame = JSON.parse data.flame
		console.debug flame
		for [x,y] in flame
			ctx.drawImage(images["flame"], x*50, y*50, 50, 50)

	client.create_game = () ->
		name = $("#input_create").val()
		$("#input_create").val("")
		socket.emit 'create_game', {name: name}

	client.join_game = () ->
		name = $("#games").val()
		socket.emit 'join_game', {name: name}

	client.fetch_games = () ->
		socket.emit 'fetch_games', {}

	$(document).keyup (event) -> 
		direction = switch event.which
			when 37 then "left"
			when 38 then "up"
			when 39 then "right"
			when 40 then "down"
			else ""
		if direction
			event.preventDefault()
			socket.emit 'move', {direction: direction}
		else if event.which is 32
			event.preventDefault()
			socket.emit 'plant', {}

</script>
</html>
